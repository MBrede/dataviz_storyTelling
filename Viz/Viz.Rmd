<!-- # --- -->
<!-- title: 'Comparison of Narratives between German and Swedish News Articles during the COVID-19 Pandemic' -->
<!-- author: 'Max Brede and Janik Dunker' -->
<!-- date: \today -->
<!-- output: -->
<!--   html_document: -->
<!--     css: styles.css -->
<!--     fig_caption: true -->
<!--     toc: true -->
<!-- --- -->

```{r setup viz, include=FALSE}
# import libraries

# library for data import, wrangling and visualization
library(tidyverse)

# library for magic pipeline operator :D
library(magrittr)

# library for subplots
library(cowplot)

# library for european geospatial data ressources
library(eurostat)

# library for plotting geospatial data
library(sf)

# library for using external fonts
library(showtext)

# library for additional color-map
library(viridis)

font_add_google('Lato', 'lato')
theme_set(theme_light(base_family = 'lato', base_size = 20))
showtext_auto()

knitr::opts_chunk$set(echo = TRUE,fig.align = 'center', warning=F, message=F, eval = T)

```


# Vizualizing the data

## Policies and Cases

Since our main goal is to see if media coverage differs in countries with different reactions to the pandemic, the first step is to analyse whether Swedish and German reactions and case numbers actually differ.

First off we want to show how the situations of new confirmed cases and the
corresponding policies differ between the two countries. This is to see, whether the countries' responses do differ as is communicated in German media.

```{r}
limits <-  as.Date(c('2020-01-01', '2020-12-31'))

# determine range of events
event_range <- timeline_data %>% select(event) %>% range()

# build color map depending on the range of events
color_map <- rev(viridis(event_range[2]+1))

# add column color and event for specific policy and corresponding policy
timeline_data %<>% mutate(color = color_map[as.integer(event)+4]) %>%
                   mutate(event = as.character(event))

# build time line plot for the Restriction of gatherings policy
time_line_plot <- ggplot(timeline_data, aes(x=start, xend=end, y=group, yend=group, color=event)) +
  geom_segment(size=10,) +
  scale_color_manual(labels=c('no restrictions', 'above 1000 people','101-1000 people', '11-100 people', '10 people or less'), values = color_map) +
  labs(x = 'Date', y = 'Country',
       colour="Restrictions on\n gatherings") +
  scale_x_date(limits = limits) 
```

After having the policy time line for Germany and Sweden the time-series for the 
normalized new cases gets added:
```{r}
# retrieve covid data from covid.ourworldindata.org git repository
covid_data <- read.csv('https://covid.ourworldindata.org/data/owid-covid-data.csv')

# filter for Germany and Sweden data and select location, date and smoothed new
# cases per million
covid_data %<>% filter(location=='Sweden' | location=='Germany') %>%
          select(location, date,
                 new_cases_smoothed_per_million) %>% # select columns of interest
          na.omit() %>% # remove rows with na entries             
          mutate(date=as.Date(as.character(date),
                              format = "%Y-%m-%d"))  # save date in date format
          


# define colors for time series plot
COLORS <- c(Germany = "steelblue", Sweden ="darkred")

# build time-series plot
lineplot <- covid_data %>% ggplot(aes(x = date, y = new_cases_smoothed_per_million,
                   group = location, color = location)) +
  geom_line() +
  scale_color_manual(values = COLORS) +
  labs(x = '', y = 'Smoothed New Cases\n per\n Million',
       colour="Countries",
       title = "Time Series of New Cases and Restrictions on Gatherings") +
  scale_x_date(limits = limits)+
  theme(plot.title = element_text(hjust = 0.5,face = 'bold'))
```

```{r, fig.cap='Time-series of smoothed new cases and restrictions on gatherings.'}
plot_grid(lineplot, time_line_plot,
          ncol = 1, align='v')

```

After cleaning the data and building the plot, we retrieve a subplot
consisting of a time series of the smoothed new cases per million of COVID-19 
for Germany and Sweden. As a comparison, we plotted the corresponding policies
Germany and Sweden released in respect to restrictions on gatherings.

That said we want to go into how situations in Germany and Sweden changed and
how the countries reacted to those. Especially of interest was the time before
the pandemic peak in Germany in April. Both countries started on restricting
gatherings. Germany reduced the allowed gatherings of 1000 people, while Sweden
was restricting it to 101-1000 people. After approximately a week Germany went into
a lockdown, while Sweden reduced the number of allowed people in a gathering to
11-100. This policy was kept by the Swedish Government until recently. 
While the German federal governments tried to lighten the policies during late summer, those attempts have been overthrown with the increasing number of new cases though.

This shows that Sweden chose way lighter policies with respect to gatherings
than Germany even with a way higher number of new confirmed cases.

So that we were asking ourself how this affected the narrative of the two countries
to each other. The idea was to compare the news reports of the countries over
each other.

## Amount of reports

Since the crisis-response seems to be different and we got the impression of the
use of Sweden as a bad example in German media, we wanted to see, whether the
reporting in both countries about the respective other differed as well.
The first aspect we found interesting, was the amount of articles over time.

Since we expect a coupling of case numbers and number of articles, we'll try to compare those. To make the comparison easier, we'll scale all values so that the relative maximum in the time frame is set to 100%. Due to rate limiting, we do only have article counts until the end of November.

```{r, fig.cap='Total amount of articles per day concerning the respective other country are displayed as points, the seven-day moving gaussian average of the amount is depicted by the dark blue line. The dashed lines depict the case numbers per 1.000.000 Inhabitants.'}

sentiment_time_series <-
  read_rds('./../data/documents_with_sentiments.rds') %>%
  mutate(publish_date = lubridate::as_date(as.Date(publish_date))) %>%
  group_by(country, publish_date) %>%
  summarise(`number of articles` = n()) %>%
  ungroup() %>%
  group_by(country) %>%
  group_split() %>%
  map(~mutate(., across(where(is.numeric), ~ 100 * . / max(.)))) %>% 
  map_dfr( ~ mutate(., across(
    where(is.numeric),
    ~ stats::filter(., filter = dnorm(seq(-2, 2, length.out = 7)) /
                      sum(dnorm(
                        seq(-2, 2, length.out = 7)
                      ))),
    .names = 'filter_{.col}'
  ))) %>%
  rename('original_number of articles' = 'number of articles') %>%
  pivot_longer(
    cols = where(is.numeric),
    values_to = 'value',
    names_to = c('quality', 'indicator'),
    names_sep = '_'
  ) %>%
  pivot_wider(names_from = quality,
              values_from = value)
  


covid_data %<>% 
  group_by(location) %>% 
  group_split() %>% 
  map_dfr(~mutate(., cases = 100 * new_cases_smoothed_per_million/max(new_cases_smoothed_per_million)))


article_timeseries_viz <- 
  sentiment_time_series %>% 
  mutate(country = recode(country,
                          Germany = 'German news \n about Sweden',
                          Sweden = 'Swedish news \n about Germany')) %>% 
  ggplot(aes(x = publish_date, y = original)) +
  geom_point(color = scales::muted('blue'), alpha = .1) +
  geom_line(aes(y = filter), color = scales::muted('blue')) +
  facet_grid(rows = vars(country),scales = 'fixed') +
  geom_line(data = covid_data, aes(y = cases, x = date, color = location)) +
  scale_color_manual(values = COLORS) +
  theme(legend.position = 'bottom',
        plot.title = element_text(hjust = 0.5,face = 'bold')) +
  labs(x = 'Date of Publication', 
       y = 'New cases and articles in % of Maximum',
       color = 'New Covid-19 cases:',
       title = 'News articles and new cases in Sweden and Germany') +
  scale_x_date(limits = as.Date(c('2020-01-01', '2020-11-20')))


article_timeseries_viz

```
By comparing these time-series with the infection-rates, one can recognize signs of a similarity in the number of German mentions of Sweden and Corona and the amount of cases in Sweden. Since the amount of articles seems to loosely be coupled to the amount of cases in the respective other country, we will look at the content of these reports. It seems interesting, whether these reports are purely factual, or if some emotional loading can be detected.


## Sentiments

Let's start by using the rather patchy sentiments we were able to gather to generate a few maps of the regions of both countries depicting the respective tonality. 

So let's first load the data and the countries' outlines:


```{r}
sf_data <- get_eurostat_geospatial(resolution = '10',
                                   nuts = 3) %>%
  filter(CNTR_CODE %in% c('SE')) %>%
  bind_rows(get_eurostat_geospatial(resolution = '10',
                                    nuts = 1) %>%
              filter(CNTR_CODE %in% c('DE'))) %>% 
  mutate(NAME_LATN = str_to_lower(NAME_LATN))


se_countrycodes <- read_tsv('https://www.iso.org/obp/ui/#iso:code:3166:SE')


regional_sents <- read_rds('./../data/documents_with_sentiments.rds') %>% 
  group_by(country) %>% 
  group_split() %>% 
  map_dfr(~group_by(.,pub_state,country) %>%  summarise(sentiment = mean(m_sentiment)))

```


Now we need to cross-reference the Mediacloud countrycodes (ISO 3166:SE, ISO 3166:DE) with the `eurostat` ones:

```{r}
iso_3166 <- read_csv('./../data/regional_codes.csv') %>% 
  mutate(across(everything(), ~str_trim(.)))%>% 
  mutate(Provinz = str_to_lower(Provinz))


regional_sents %<>%
  right_join(iso_3166, by = c(pub_state = 'Code'))
```

This dataset can now be used to depict the overall regional sentiment in both countries:

```{r, fig.cap='Mean sentiment per region as detected in the mainstream-news articles about the respective other country.'}
reg_sent_plot <- function(data,legend){
  p <- ggplot(data) +
    geom_sf(aes(geometry = geometry,fill = sentiment), color = 'grey', expand = F) +
    scale_fill_gradient2(low = scales::muted('red'), 
                         mid = 'white',
                         high = scales::muted('blue'),
                         na.value = 'lightgrey',
                         limits = c(-5,5))  +
    cowplot::theme_map()
    if(!legend){
      p <- p + theme(legend.position = 'none')
    }else{
      p <- p + theme_void() + theme(legend.position = 'right')
    }
  p +
    coord_sf(crs = st_crs("+proj=merc"))
}

plots <- sf_data %>% 
  left_join(regional_sents[,c('Provinz', 'sentiment')],by = c('NAME_LATN' = 'Provinz')) %>% 
  group_by(CNTR_CODE) %>%
  group_split() %>%
  purrr::map(~reg_sent_plot(.,legend = F))

legend <- cowplot::get_legend(reg_sent_plot(mutate(sf_data,sentiment = 0),legend = T))


cowplot::plot_grid(
  cowplot::plot_grid(plotlist = plots,
                     labels = c('Germany about Sweden', 'Sweden about Germany')),
  legend,
  rel_widths =  c(4,.6)
)


 
```


Since the sentiments are not really the way we would like it, a qualitative approach has to make do. We decided to create some wordclouds to get a better impression of the reports' tonality.


```{r, fig.cap='Most commonly used terms in the mainstream-news reporting about the respective other country. The color codes the sentiment if any could be associated.'}

wc_data <- read_rds('./../data/wordcloud_data.rds')


wordcloud <- function(wc_data,country){
  require(ggwordcloud)
  p <- get_eurostat_geospatial(resolution = '10',
                                   nuts = 0) %>%
    filter(CNTR_CODE %in% c(country)) %>% 
    ggplot() +
    geom_sf(fill = 'black', color = 'black') +
    coord_sf(crs = st_crs("+proj=moll")) +
    theme_void()
  ggsave('temp.png', plot = p)
  img <- png::readPNG('temp.png')
  dummy <- colSums(img[,,1]) != max(colSums(img[,,1]))
  img <- img[,dummy,]
  dummy <- rowSums(img[,,1]) != max(rowSums(img[,,1]))
  img <- img[dummy,,]
  
  wc <- ggplot(wc_data,aes(label = translation, size = n, color = sentiment)) + 
    geom_text_wordcloud(mask = img,rm_outside = T)+
    scale_color_gradient2(low = scales::muted('red'), 
                         mid = 'grey',
                         high = scales::muted('blue'),
                         na.value = 'darkgrey',
                         limits = c(-5,5))
  file.remove('temp.png')
  wc
}
 
ger_wc <- wc_data %>% 
  filter(country == 'Germany') %>% 
  arrange(desc(n)) %>% 
  head(500) %>%
  wordcloud(country = 'DE')

swe_wc <- wc_data %>% 
  filter(country == 'Sweden') %>% 
  arrange(desc(n)) %>% 
  head(500) %>% 
  wordcloud(country = 'SE')

cowplot::plot_grid(ger_wc, swe_wc)

```