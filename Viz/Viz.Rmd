---
title: "Visualisierung"
output:
  # pdf_document:
  #   includes:
  #     in_header: header_doc.tex
  html_document:
    css: styles.css
    fig_caption: true
    toc: true
---

```{r setup, include=FALSE}
# test
library(knitr)
library(kableExtra)
library(tidyverse)

opts_chunk$set(echo = TRUE,fig.align = 'center')

theme_set(theme_light())
```

## Viz 1

Vergleich Schweden Deutschland - Indizienden oder positiv-Tests oder relative Fallzahlen oder alles (timeseries) [Inzidenz- und Testdaten](https://covid.ourworldindata.org/data/owid-covid-data.csv)

## Attaining the data
For attaining the covid-19 policy data we read the data from the github of the
[Coronavirus Government Response Tracker Project](https://www.bsg.ox.ac.uk/research/research-projects/coronavirus-government-response-tracker#data).

```{r, cache=TRUE}
# read policies csv-file
policies <- read.csv('https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv')
```

After reading the data, we take a glimpse on the data.
```{r}
# take a glimpse of the policy data
glimpse(policies)
```
For the meanings of specific policies take a look on the [Codebook](https://github.com/OxCGRT/covid-policy-tracker/blob/master/documentation/codebook.md) of the project.


The data set gets filtered for german policies and the relevant policies get selected.

```{r}
# a function for pre filtering

filtering <- function(country_name, policy_filter) {
   policies_ger <- policies %>%
                filter(CountryName==country_name) %>% # filter policies by germany
                select(policy_filter) %>% # select policies of interest
                mutate(Date=as.Date(as.character(Date),
                                    format = "%Y%m%d")) %>% # change date format
                na.omit() %>% # remove rows with na entries
                arrange(Date) # order rows by date
}
```

```{r}
# a function to build start and stop labels for the equivalent policy
build_start_stop_labels <- function(policies, policy, label){
  # get selected policy data
  selected_policy <- policies %>%
                      select(Date, policy)

  # build bit-mask for policy changes
  bit_mask <- selected_policy[,policy] -  lag(selected_policy[,policy], n = 1) != 0

  # set last entry true (is na because of lag)
  bit_mask[is.na(bit_mask)] <- TRUE
  
  # initialize start and stop list
  start <- c()
  stop <- c()

  # initialize a state variable for tracking start position
  start_state <- TRUE

  # iterate through rows for finding start and stop positions
  for(row in 1:length(bit_mask)){
    # check whether it's a stop position
    if(bit_mask[row] & !start_state){
      stop <- c(stop, row-1)
      start_state <- TRUE
    }
    # check whether it's a start position
    if(bit_mask[row] & start_state){
      start <- c(start, row)
      start_state <- FALSE
    }
  }

  # add last row as stop
  stop <- c(stop, row)
  
  # retrieve start and stop dates from the data set
  start_date <- selected_policy[start, 'Date']
  stop_date <- selected_policy[stop, 'Date']
  # retrieve event number from the data set
  events <- selected_policy[start, policy]
  
  # return dataframe with start/stop dates for the polcies
  return(data.frame(event = events, start = start_date, end = stop_date,
                    group = label))
}

```

```{r}
# set filter for columns of interest
policy_filter <- c('CountryCode', 'Date', 'C8_International.travel.controls',
  'C6_Stay.at.home.requirements', 'C4_Restrictions.on.gatherings')

# retrieve policy data
policies_ger <- filtering('Germany', policy_filter)
policies_se <- filtering('Sweden', policy_filter)

timeline_data <- rbind(build_start_stop_labels(policies_ger,
                                               'C4_Restrictions.on.gatherings',
                                               'Germany'),
                       build_start_stop_labels(policies_se,
                                               'C4_Restrictions.on.gatherings',
                                               'Sweden'))


# load vistime
library(vistime)

# determine range of events
event_range <- timeline_data %>% select(event) %>% range()

color_map <- rev(heat.colors(event_range[2] + 5))

timeline_data %<>% mutate(color = color_map[as.integer(event)+4]) %>%
                   mutate(event = as.character(event))


test <- color_map[6:10]

# plot timeline
time_line_plot <- timeline_data %>% gg_vistime() +
                  scale_color_manual(values = c('grey',
                                                'green',
                                                'blue',
                                                'red',
                                                'yellow',
                                                'black'))

library(viridis)
color_map <- rev(viridis(event_range[2]+1))

time_line_plot <- ggplot(timeline_data, aes(x=start, xend=end, y=group, yend=group, color=event)) +
  geom_segment(size=10) +
  scale_color_manual(labels=c('no restrictions', 'above 1000 people','101-1000 people', '11-100 people', '10 people or less'), values = color_map) +
  labs(x = 'Date', y = 'Country',
       colour="Restrictions on\n gatherings")


time_line_plot
```

```{r, cache=TRUE}
# retrieve covid data from covid.ourworldindata.org git repository
covid_data <- read.csv('https://covid.ourworldindata.org/data/owid-covid-data.csv')

# filter for datasets of interest
covid_data %<>% filter(location=='Germany' | location=='Sweden') %>% # filter policies by germany
                select(location, date,
                       new_cases_smoothed_per_million) %>% # select columns of interest
                na.omit() %>% # remove rows with na entries              
                mutate(date=as.Date(as.character(date),
                                    format = "%Y-%m-%d")) # change date format

```

```{r}
# retrieve swedish data from dataframe and plot
library(magrittr)
# retrieve covid data from covid.ourworldindata.org git repository
covid_data_df <- read.csv('https://covid.ourworldindata.org/data/owid-covid-data.csv')

covid_data <- covid_data_df

covid_data %<>% filter(location=='Sweden' | location=='Germany') %>%
          select(location, date,
                 new_cases_smoothed_per_million) %>% # select columns of interest
          na.omit() %>% # remove rows with na entries             
          mutate(date=as.Date(as.character(date),
                              format = "%Y-%m-%d")) # save date in date format

COLORS <- c(Germany = "steelblue", Sweden ="darkred")

lineplot <- covid_data %>% ggplot(aes(x = date, y = new_cases_smoothed_per_million,
                   group = location, color = location)) +
  geom_line() +
  scale_color_manual(values = COLORS) +
  labs(x = '', y = 'Smoothed New Cases\n per\n Million',
       colour="Countries")

lineplot
```

```{r}
install.packages('cowplot')
library(cowplot)
plot_grid(lineplot, time_line_plot,
          ncol = 1, align='v')

```

Zeitreihen in Facets, [Massnahmen](https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv) 

## Viz 2

Zeitreihen Zeitungsartikel 
```{r}
sentiment_time_series <-
  read_rds('./../data/documents_with_sentiments.rds') %>%
  mutate(publish_date = lubridate::as_date(as.Date(publish_date))) %>%
  group_by(country, publish_date) %>%
  summarise(sentiment = mean(m_sentiment),
            `number of articles` = n()) %>%
  ungroup() %>%
  group_by(country) %>%
  group_split() %>%
  map_dfr( ~ mutate(., across(
    where(is.numeric),
    ~ stats::filter(., filter = dnorm(seq(-2, 2, length.out = 7)) /
                      sum(dnorm(
                        seq(-2, 2, length.out = 7)
                      ))),
    .names = 'filter_{.col}'
  ))) %>%
  rename('original_number of articles' = 'number of articles',
         'original_sentiment' = sentiment) %>%
  pivot_longer(
    cols = where(is.numeric),
    values_to = 'value',
    names_to = c('quality', 'indicator'),
    names_sep = '_'
  ) %>%
  pivot_wider(names_from = quality,
              values_from = value)

sentiment_time_series %>% 
  ggplot(aes(x = publish_date, y = original)) +
  geom_point(color = 'blue', alpha = .25) +
  geom_line(aes(y = filter), color = 'blue') +
  facet_wrap(indicator ~ country,scales = 'free')
  
```



## Viz 3

Wordclouds f√ºr interessante Zeitpunkte
```{r}
library(tmap)
library(sf)

data(World, package = "tmap")  # load data from tmap package
world <- World                 # rename

se <- world %>% filter(name == "Sweden") %>%
                pull(geometry)


png('sweden_shape.png')
plot(se, col='black')
dev.off()


library(ggwordcloud)
#> Loading required package: ggplot2
data("love_words_small")
data("love_words")

set.seed(42)
ggplot(love_words, aes(label = word, size = speakers)) +
  geom_text_wordcloud_area(
    mask = png::readPNG("./sweden_shape.png"),
    rm_outside = TRUE
  ) +
  scale_size_area(max_size = 18) +
  theme_minimal()

```
```{r}
library(tmap)
library(sf)

data(World, package = "tmap")  # load data from tmap package
world <- World                 # rename

se <- world %>% filter(name == "Germany") %>%
                pull(geometry)


png('germany_shape.png')
plot(se, col='black')
dev.off()


library(ggwordcloud)
#> Loading required package: ggplot2
data("love_words_small")
data("love_words")

set.seed(42)
ggplot(love_words, aes(label = word, size = speakers)) +
  geom_text_wordcloud_area(
    mask = png::readPNG("./germany_shape.png"),
    rm_outside = TRUE
  ) +
  scale_size_area(max_size = 18) +
  xlim(-2.5,2.5) +
  theme_void()

```