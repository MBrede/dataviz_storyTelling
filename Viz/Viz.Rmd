---
title: "Visualisierung"
output:
  # pdf_document:
  #   includes:
  #     in_header: header_doc.tex
  html_document:
    css: styles.css
    fig_caption: true
    toc: true
---

```{r setup, include=FALSE}
# test
library(knitr)
library(kableExtra)
library(tidyverse)

opts_chunk$set(echo = TRUE,fig.align = 'center')

theme_set(theme_light())
```

## Viz 1

Vergleich Schweden Deutschland - Indizienden oder positiv-Tests oder relative Fallzahlen oder alles (timeseries) [Inzidenz- und Testdaten](https://covid.ourworldindata.org/data/owid-covid-data.csv)

## Attaining the data
For attaining the covid-19 policy data we read the data from the github of the
[Coronavirus Government Response Tracker Project](https://www.bsg.ox.ac.uk/research/research-projects/coronavirus-government-response-tracker#data).

```{r, cache=TRUE}
# read policies csv-file
policies <- read.csv('https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv')
```

After reading the data, we take a glimpse on the data.
```{r}
# take a glimpse of the policy data
glimpse(policies)
```
For the meanings of specific policies take a look on the [Codebook](https://github.com/OxCGRT/covid-policy-tracker/blob/master/documentation/codebook.md) of the project.


The data set gets filtered for german policies and the relevant policies get selected.

```{r}

policies_ger <- policies %>%
                filter(CountryName=='Germany') %>% # filter policies by germany
                select(CountryCode, Date, C8_International.travel.controls,
                       C6_Stay.at.home.requirements,
                       C4_Restrictions.on.gatherings)%>% # select policies of interest
                mutate(Date=as.Date(as.character(Date),
                                    format = "%Y%m%d")) %>% # change date format
                na.omit() # remove rows with na entries
                arrange(Date) # order rows by date

library(magrittr)

travel_controls <- policies_ger %>%
                      select(Date, C8_International.travel.controls)


bit_mask <- travel_controls[,'C8_International.travel.controls'] -  lag(travel_controls[,'C8_International.travel.controls'], n = 1) != 0

bit_mask[is.na(bit_mask)] <- TRUE
start <- c()
stop <- c()

start_holder <- TRUE

for(row in 1:length(bit_mask)){
  # check whether it's a stop position
  if(bit_mask[row] & !start_holder){
    stop <- c(stop, row-1)
    start_holder <- TRUE
  }
  # check whether it's a start position
  if(bit_mask[row] & start_holder){
    start <- c(start, row)
    start_holder <- FALSE
  }
}

stop <- c(stop, row)
start_date <- travel_controls[start, 'Date']
stop_date <- travel_controls[stop, 'Date']
events <- travel_controls[start, 'C8_International.travel.controls']


timeline_data <- data.frame(event = events, start = start_date, end = stop_date,
                            group = "International Travel Controls")
vistime(timeline_data)





stay_home_requirements <- policies_ger %>%
                          select(Date, C6_Stay.at.home.requirements)


bit_mask <- stay_home_requirements[,'C6_Stay.at.home.requirements'] -  lag(stay_home_requirements[,'C6_Stay.at.home.requirements'], n = 1) != 0

bit_mask[is.na(bit_mask)] <- TRUE
start <- c()
stop <- c()

start_holder <- TRUE

for(row in 1:length(bit_mask)){
  # check whether it's a stop position
  if(bit_mask[row] & !start_holder){
    stop <- c(stop, row-1)
    start_holder <- TRUE
  }
  # check whether it's a start position
  if(bit_mask[row] & start_holder){
    start <- c(start, row)
    start_holder <- FALSE
  }
}

stop <- c(stop, row)
start_date <- stay_home_requirements[start, 'Date']
stop_date <- stay_home_requirements[stop, 'Date']
events <- stay_home_requirements[start, 'C6_Stay.at.home.requirements']

timeline_data <- rbind(timeline_data, data.frame(event = events,
                                                 start = start_date,
                                                 end = stop_date,
                                                 group = "Stay at Home"))

vistime(timeline_data)








restriction_gatherings <- policies_ger %>%
                          select(Date, C4_Restrictions.on.gatherings)


bit_mask <- restriction_gatherings[,'C4_Restrictions.on.gatherings'] -  lag(restriction_gatherings[,'C4_Restrictions.on.gatherings'], n = 1) != 0

bit_mask[is.na(bit_mask)] <- TRUE
start <- c()
stop <- c()

start_holder <- TRUE

for(row in 1:length(bit_mask)){
  # check whether it's a stop position
  if(bit_mask[row] & !start_holder){
    stop <- c(stop, row-1)
    start_holder <- TRUE
  }
  # check whether it's a start position
  if(bit_mask[row] & start_holder){
    start <- c(start, row)
    start_holder <- FALSE
  }
}

stop <- c(stop, row)
start_date <- restriction_gatherings[start, 'Date']
stop_date <- restriction_gatherings[stop, 'Date']
events <- restriction_gatherings[start, 'C4_Restrictions.on.gatherings']

timeline_data <- rbind(timeline_data, data.frame(event = events,
                                                 start = start_date,
                                                 end = stop_date,
                                                 group = "Gathering Restrictions"))
vistime(timeline_data)

```


```{r, cache=TRUE}
# COVID-19 Timeline
covid_data <- read.csv('https://covid.ourworldindata.org/data/owid-covid-data.csv')

covid_data %<>% filter(location=='Germany' | location=='Sweden') %>% # filter policies by germany
                select(location, date, new_cases_smoothed_per_million) %>% # select columns of interest
                na.omit() %>% # remove rows with na entries              
                mutate(date=as.Date(as.character(date),
                                    format = "%Y-%m-%d")) # change date format

covid_data %>% filter(location=='Germany') %>% ggplot(aes(x = date,
                                                          y = new_cases_smoothed_per_million)) +
  geom_area(color='black', fill = 'red', alpha = 0.5) +
  labs(x = 'Date', y = 'Smoothed New Cases per Million')
  #           alpha = 0.5, position = position_dodge(0.8)) +
  # scale_color_manual(values = c("#00AFBB")) +
  # scale_fill_manual(values = c("#00AFBB"))
  ```


```{r}
# convert numerical classes into text


```

```{r}
# filter policies by sweden

```

Zeitreihen in Facets, [Massnahmen](https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv) 

## Viz 2

Zeitreihen Zeitungsartikel 

## Viz 3

Wordclouds f√ºr interessante Zeitpunkte
```{r}
# read meta data for germany
word_data <- readRDS('data/german_meta.rds')

```
